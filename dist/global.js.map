{"version":3,"file":"global.js","mappings":"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","sources":["webpack://customAttributes/webpack/bootstrap","webpack://customAttributes/webpack/runtime/define property getters","webpack://customAttributes/webpack/runtime/hasOwnProperty shorthand","webpack://customAttributes/webpack/runtime/make namespace object","webpack://customAttributes/./src/CustomAttributeRegistry.ts","webpack://customAttributes/./src/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","import type {Constructor} from 'lowclass'\n\nconst forEach = Array.prototype.forEach\n\nexport class CustomAttributeRegistry {\n\tprivate _attrMap = new Map<string, Constructor>()\n\tprivate _elementMap = new WeakMap<Element, Map<string, CustomAttribute>>()\n\n\tprivate _observer: MutationObserver = new MutationObserver(mutations => {\n\t\tforEach.call(mutations, (m: MutationRecord) => {\n\t\t\tif (m.type === 'attributes') {\n\t\t\t\tconst attr = this._getConstructor(m.attributeName!)\n\t\t\t\tif (attr) this._handleChange(m.attributeName!, m.target as Element, m.oldValue)\n\t\t\t}\n\n\t\t\t// chlidList\n\t\t\telse {\n\t\t\t\tforEach.call(m.removedNodes, this._elementDisconnected)\n\t\t\t\tforEach.call(m.addedNodes, this._elementConnected)\n\t\t\t}\n\t\t})\n\t})\n\n\tconstructor(public ownerDocument: Document | ShadowRoot) {\n\t\tif (!ownerDocument) throw new Error('Must be given a document')\n\t}\n\n\tdefine(attrName: string, Class: Constructor) {\n\t\tthis._attrMap.set(attrName, Class)\n\t\tthis._upgradeAttr(attrName)\n\t\tthis._reobserve()\n\t}\n\n\tget(element: Element, attrName: string) {\n\t\tconst map = this._elementMap.get(element)\n\t\tif (!map) return\n\t\treturn map.get(attrName)\n\t}\n\n\tprivate _getConstructor(attrName: string) {\n\t\treturn this._attrMap.get(attrName)\n\t}\n\n\tprivate _observe() {\n\t\tthis._observer.observe(this.ownerDocument, {\n\t\t\tchildList: true,\n\t\t\tsubtree: true,\n\t\t\tattributes: true,\n\t\t\tattributeOldValue: true,\n\t\t\tattributeFilter: Array.from(this._attrMap.keys()),\n\t\t\t// attributeFilter: [...this._attrMap.keys()], // Broken in Oculus\n\t\t\t// attributeFilter: this._attrMap.keys(), // This works in Chrome, but TS complains, and not clear if it should work in all browsers yet: https://github.com/whatwg/dom/issues/1092\n\t\t})\n\t}\n\n\tprivate _unobserve() {\n\t\tthis._observer.disconnect()\n\t}\n\n\tprivate _reobserve() {\n\t\tthis._unobserve()\n\t\tthis._observe()\n\t}\n\n\tprivate _upgradeAttr(attrName: string, node: Element | Document | ShadowRoot = this.ownerDocument) {\n\t\tconst matches = node.querySelectorAll('[' + attrName + ']')\n\n\t\t// Possibly create custom attributes that may be in the given 'node' tree.\n\t\t// Use a forEach as Edge doesn't support for...of on a NodeList\n\t\tforEach.call(matches, (element: Element) => this._handleChange(attrName, element, null))\n\t}\n\n\tprivate _elementConnected = (element: Element) => {\n\t\tif (element.nodeType !== 1) return\n\n\t\t// For each of the connected element's attribute, possibly instantiate the custom attributes.\n\t\t// Use a forEach as Safari 10 doesn't support for...of on NamedNodeMap (attributes)\n\t\tforEach.call(element.attributes, (attr: Attr) => {\n\t\t\tif (this._getConstructor(attr.name)) this._handleChange(attr.name, element, null)\n\t\t})\n\n\t\t// Possibly instantiate custom attributes that may be in the subtree of the connected element.\n\t\tthis._attrMap.forEach((_constructor, attr) => this._upgradeAttr(attr, element))\n\t}\n\n\tprivate _elementDisconnected = (element: Element) => {\n\t\tconst map = this._elementMap.get(element)\n\t\tif (!map) return\n\n\t\tmap.forEach(inst => inst.disconnectedCallback?.(), this)\n\n\t\tthis._elementMap.delete(element)\n\t}\n\n\tprivate _handleChange(attrName: string, el: Element, oldVal: string | null) {\n\t\tlet map = this._elementMap.get(el)\n\t\tif (!map) this._elementMap.set(el, (map = new Map()))\n\n\t\tlet inst = map.get(attrName)\n\t\tconst newVal = el.getAttribute(attrName)\n\n\t\t// Attribute is being created\n\t\tif (!inst) {\n\t\t\tconst Constructor = this._getConstructor(attrName)!\n\t\t\tinst = new Constructor() as CustomAttribute\n\t\t\tmap.set(attrName, inst)\n\t\t\tinst.ownerElement = el\n\t\t\tinst.name = attrName\n\t\t\tif (newVal == null) throw new Error('Not possible!')\n\t\t\tinst.value = newVal\n\t\t\tinst.connectedCallback?.()\n\t\t\treturn\n\t\t}\n\n\t\t// Attribute was removed\n\t\tif (newVal == null) {\n\t\t\tinst.disconnectedCallback?.()\n\t\t\tmap.delete(attrName)\n\t\t}\n\n\t\t// Attribute changed\n\t\telse if (newVal !== inst.value) {\n\t\t\tinst.value = newVal\n\t\t\tif (oldVal == null) throw new Error('Not possible!')\n\t\t\tinst.changedCallback?.(oldVal, newVal)\n\t\t}\n\t}\n}\n\n// TODO Replace with a class that extends from `Attr` for alignment with the web platform?\nexport interface CustomAttribute {\n\townerElement: Element\n\tname: string\n\tvalue: string\n\tconnectedCallback?(): void\n\tdisconnectedCallback?(): void\n\tchangedCallback?(oldValue: string, newValue: string): void\n}\n\n// Avoid errors trying to use DOM APIs in non-DOM environments (f.e. server-side rendering).\nif (globalThis.window?.document) {\n\tconst _attachShadow = Element.prototype.attachShadow\n\n\tElement.prototype.attachShadow = function attachShadow(options) {\n\t\tconst root = _attachShadow.call(this, options)\n\n\t\tif (!root.customAttributes) root.customAttributes = new CustomAttributeRegistry(root)\n\n\t\treturn root\n\t}\n}\n","// TODO We don't know when a ShadowRoot is no longer referenced, hence we cannot\n// unobserve them. Verify that MOs are cleaned up once ShadowRoots are no longer\n// referenced.\n\nimport {CustomAttributeRegistry} from './CustomAttributeRegistry.js'\n\nexport * from './CustomAttributeRegistry.js'\n\nexport let customAttributes: CustomAttributeRegistry\n\n// Avoid errors trying to use DOM APIs in non-DOM environments (f.e. server-side rendering).\nif (globalThis.window?.document) customAttributes = globalThis.customAttributes = new CustomAttributeRegistry(document)\n\ndeclare global {\n\t// const doesn't always work (TS bug). At time of writing this, it doesn't work in this TS playground example:\n\t// https://www.typescriptlang.org/play?#code/KYDwDg9gTgLgBAbzgXwFCoCbAMYBsCGUwcA5rhAEb66KpxzYQB2AzvAGYQQBccTArgFsKwKKjSoylagBUAFgEsWAOk4Q4Aeg1wAolCjQANHAXwYipgGsWcAAZrbJm0wjws7BU2AYgA\n\t// And discussions:\n\t// https://discord.com/channels/508357248330760243/508357248330760249/1019034094060978228\n\t// https://discord.com/channels/508357248330760243/1019017621397585961\n\tvar customAttributes: CustomAttributeRegistry\n\n\tinterface ShadowRoot {\n\t\tcustomAttributes: CustomAttributeRegistry\n\t}\n\n\tinterface Window {\n\t\tcustomAttributes: CustomAttributeRegistry\n\t}\n}\n\nexport const version = '0.1.7'\n"],"names":["__webpack_require__","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","forEach","Array","CustomAttributeRegistry","constructor","ownerDocument","_attrMap","Map","_elementMap","WeakMap","_observer","MutationObserver","mutations","m","type","this","_getConstructor","attributeName","_handleChange","target","oldValue","removedNodes","_elementDisconnected","addedNodes","_elementConnected","element","nodeType","attributes","attr","name","_constructor","_upgradeAttr","map","inst","disconnectedCallback","delete","Error","define","attrName","Class","set","_reobserve","_observe","observe","childList","subtree","attributeOldValue","attributeFilter","from","keys","_unobserve","disconnect","node","matches","querySelectorAll","el","oldVal","newVal","getAttribute","ownerElement","connectedCallback","changedCallback","globalThis","window","document","_attachShadow","Element","attachShadow","options","root","customAttributes","version"],"sourceRoot":""}